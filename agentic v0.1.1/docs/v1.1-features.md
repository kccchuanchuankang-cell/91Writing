# v1.1.0 新功能使用指南

## 🎉 三大核心改进

### 1. 推理过程保存和查看

**功能说明**：
- Agent 的每次回复都会保存完整的推理过程（Thought、Action、Observation等）
- 可以点击 AI 消息下方的"💭 查看推理过程"按钮展开查看
- 推理过程包含在对话历史的 metadata 中，持久化保存

**使用方法**：
1. 与 AI 对话后，AI 的回复下方会显示"💭 查看推理过程"
2. 点击即可展开，再次点击可折叠
3. 推理过程显示完整的 ReAct 循环：思考→动作→结果

**示例**：
```
💭 查看推理过程

==================================================
🔄 第 1 轮推理...
==================================================

---LLM输出---
Thought: 用户询问主角是谁，我需要查看人物设定文件
Action: list_files
Action Input: "人物设定"

✅ 结果: 📂 人物设定/
  - 中国神系六大角色.md
  - 2025-10-01T14-35-02-629Z_配角-苏红药.md
  ...
```

### 2. 文件浏览和编辑器

**新增功能**：
- 显示所有7个文件类型标签（人物、世界观、章节、大纲、灵感、资料、笔记）
- 点击文件打开独立编辑器，而不是添加到对话框
- 大屏幕编辑器（90%屏幕宽度，80%高度）
- 支持直接编辑和保存文件

**使用方法**：
1. 在左侧文件浏览器选择文件类型
2. 点击任意文件，会弹出编辑器
3. 在编辑器中查看或修改内容
4. 点击"💾 保存"按钮保存修改
5. 点击"×"或"取消"关闭编辑器

**快捷键**：
- 无（计划添加 Ctrl+S 保存）

### 3. 删除对话消息

**功能说明**：
- 鼠标悬停在任意消息上时，右上角显示"×"删除按钮
- 可以删除任意历史消息
- 删除后自动重新加载对话历史

**使用方法**：
1. 将鼠标移到要删除的消息上
2. 点击右上角的"×"按钮
3. 确认删除
4. 消息被永久删除，对话历史自动刷新

**注意事项**：
- 删除操作不可撤销
- 删除消息会影响 AI 的上下文理解
- 建议只删除错误或无关的消息

## 🔧 技术细节

### 对话历史文件格式

```json
{
  "projectName": "未来神战",
  "lastUpdated": "2025-10-02T10:30:00.000Z",
  "totalMessages": 15,
  "history": [
    {
      "role": "user",
      "content": "当前小说的主角是谁",
      "timestamp": "2025-10-02T10:00:00.000Z"
    },
    {
      "role": "assistant",
      "content": "根据人物设定，主角是...",
      "timestamp": "2025-10-02T10:01:00.000Z",
      "metadata": {
        "thinkingProcess": "完整的推理过程文本...",
        "iterations": 3,
        "scratchpad": "Agent 的工作记录..."
      }
    }
  ]
}
```

### 新增 API 端点

**1. 删除消息**
```
DELETE /api/projects/:name/conversation-history/:index
```
- 参数：index (消息索引，从0开始)
- 返回：{ success: true, message: "消息已删除" }

**2. 保存文件**
```
PUT /api/projects/:name/files/:type/:filename
```
- Body: { content: "文件内容" }
- 返回：{ success: true, message: "文件已保存" }

## 📱 界面更新

### 文件类型标签

之前只有4个：
- 人物、世界观、章节、大纲

现在有7个：
- 人物、世界观、章节、大纲、灵感、资料、笔记

### 样式优化

**消息删除按钮**：
- 默认隐藏，悬停时显示
- 红色半透明背景
- 悬停时放大效果

**推理过程**：
- 灰色背景区域
- 最大高度200px，超出滚动
- 等宽字体显示，方便阅读代码

**文件编辑器**：
- 90%屏幕宽度，80%高度
- 等宽字体，适合编辑 Markdown
- 大尺寸关闭按钮

## 🎯 使用建议

### 1. 利用推理过程调试

当 AI 的回复不符合预期时：
1. 查看推理过程
2. 检查 AI 调用了哪些工具
3. 观察工具返回的结果
4. 理解 AI 的决策逻辑
5. 根据需要修改提示词或工具

### 2. 管理对话历史

**保留有价值的对话**：
- 删除错误或测试消息
- 保留重要的创作决策
- 定期清理冗余对话

**控制上下文长度**：
- 系统自动保留最新20条消息
- 加载时使用最新10条作为上下文
- 可以手动删除不需要的消息

### 3. 文件编辑最佳实践

**何时使用编辑器**：
- 需要修改大段文字
- 调整格式和结构
- 快速查看文件内容
- 修正AI生成的小错误

**何时使用 AI**：
- 创建新内容
- 大幅度改写
- 需要创意和构思
- 保持风格一致性

## 🐛 已知问题

1. **推理过程格式**：长推理过程可能格式混乱
2. **编辑器快捷键**：暂不支持键盘快捷键
3. **文件预览**：不支持 Markdown 实时预览
4. **撤销功能**：删除消息和文件编辑都不可撤销

## 🔮 未来计划

### v1.2.0
- [ ] Markdown 实时预览
- [ ] 文件比较和版本历史
- [ ] 导出对话历史为 Markdown
- [ ] 搜索历史消息
- [ ] 编辑器语法高亮

### v1.3.0
- [ ] 多文件同时编辑
- [ ] 文件树结构显示
- [ ] 拖拽上传文件
- [ ] 批量操作（删除、移动）

## 📖 相关文档

- [对话历史功能说明](conversation-history.md)
- [提示词模板修复说明](prompt-template-fix.md)
- [更新日志](../CHANGELOG.md)

