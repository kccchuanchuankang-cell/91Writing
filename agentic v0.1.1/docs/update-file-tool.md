# 📝 文件更新工具使用指南

## 🎯 功能概述

`update_file` 工具支持对已有文件进行精确更新，特别适合审稿和改写场景。支持两种更新模式：

1. **diff 模式**：精确替换某段文字（推荐用于审稿改写）
2. **full 模式**：替换整个文件内容（用于大幅改写）

## 🔧 工具列表

### 1. update_file

更新已有文件的内容，支持 diff 格式的精确替换。

**参数**：
```json
{
    "type": "文件夹类型（人物设定|世界观设定|章节内容|大纲|灵感记录|设定资料|创作笔记）",
    "filename": "要更新的文件名（完整文件名）",
    "mode": "更新模式（diff 或 full）",
    "old_string": "要替换的原文（仅 diff 模式需要，必须完全匹配）",
    "new_string": "替换后的新文（diff 模式必填 / full 模式是完整新内容）",
    "revision_note": "修改说明（可选）"
}
```

### 2. view_revision_history

查看文件的修改历史记录。

**参数**：
```json
{
    "type": "文件夹类型",
    "filename": "文件名"
}
```

## 📖 使用场景

### 场景 1：审稿改写（diff 模式）

**用户需求**：
> "帮我审稿改写 Chapter 7，把第一段的描写改得更生动"

**Agent 操作流程**：

1. **读取文件**：
```json
{
    "tool": "read_file",
    "params": {
        "type": "章节内容",
        "filename": "2025-10-02T05-51-00-896Z_Chapter 7 神陨滩头·诺曼底逆潮.md"
    }
}
```

2. **精确更新**（diff 模式）：
```json
{
    "tool": "update_file",
    "params": {
        "type": "章节内容",
        "filename": "2025-10-02T05-51-00-896Z_Chapter 7 神陨滩头·诺曼底逆潮.md",
        "mode": "diff",
        "old_string": "英吉利海峡的浪头像被月亮磨亮的刀，一刀刀砍在登陆艇的钢板上。",
        "new_string": "英吉利海峡的浪头像被月光淬炼的利刃，寒光凛凛，一刀接一刀重重砍在登陆艇的钢板上，溅起冰冷的水花。",
        "revision_note": "第一段描写改写：增加感官细节和动态感"
    }
}
```

3. **工具输出**：
```
✅ 文件更新成功！

📄 文件：章节内容/2025-10-02T05-51-00-896Z_Chapter 7 神陨滩头·诺曼底逆潮.md
🔄 更新模式：Diff 替换
💾 备份文件：2025-10-02T05-51-00-896Z_Chapter 7 神陨滩头·诺曼底逆潮.backup-2025-10-02T10-30-15-123Z.md
📊 修改次数：第 1 次修改
📝 修改说明：第一段描写改写：增加感官细节和动态感

📝 修改摘要：
- 替换位置：第 10 行附近
- 原文行数：1 行
- 新文行数：1 行
- 字数变化：30 → 48 字（+18）

🔍 Diff 预览：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
- 删除的内容：
英吉利海峡的浪头像被月亮磨亮的刀，一刀刀砍在登陆艇的钢板上。

+ 添加的内容：
英吉利海峡的浪头像被月光淬炼的利刃，寒光凛凛，一刀接一刀重重砍在登陆艇的钢板上，溅起冰冷的水花。
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

💡 提示：
- 备份文件已保存，可用于回滚
- 修改历史已记录
```

---

### 场景 2：全文改写（full 模式）

**用户需求**：
> "把 Chapter 7 完全重写，改成第一人称视角"

**Agent 操作流程**：

1. **读取原文**：
```json
{
    "tool": "read_file",
    "params": {
        "type": "章节内容",
        "filename": "2025-10-02T05-51-00-896Z_Chapter 7 神陨滩头·诺曼底逆潮.md"
    }
}
```

2. **全量替换**：
```json
{
    "tool": "update_file",
    "params": {
        "type": "章节内容",
        "filename": "2025-10-02T05-51-00-896Z_Chapter 7 神陨滩头·诺曼底逆潮.md",
        "mode": "full",
        "new_string": "我紧紧抱着M1步枪，胸前的锡盒随着登陆艇的颠簸一下一下撞击我的肋骨...",
        "revision_note": "改写为第一人称视角"
    }
}
```

---

### 场景 3：多段落改写

**用户需求**：
> "帮我审稿，修改 Chapter 7 中关于施密特的描写，让他的形象更立体"

**Agent 操作流程**：

1. **读取文件**
2. **找到相关段落**
3. **使用 diff 模式精确替换**：

```json
{
    "tool": "update_file",
    "params": {
        "type": "章节内容",
        "filename": "2025-10-02T05-51-00-896Z_Chapter 7 神陨滩头·诺曼底逆潮.md",
        "mode": "diff",
        "old_string": "左侧，德军上尉海因茨·施密特踉跄走出残堡。他的双眼蒙着一层水银，掌心裂开，微型如尼炮阵在血肉里旋转，炮口先对准墨菲，又缓缓转向自己的太阳穴。施密特的嘴角扯出陌生的笑，像有人借他的唇说话："人类，你赢了。"",
        "new_string": "左侧，德军上尉海因茨·施密特踉跄走出残堡。曾经锐利的蓝眼睛如今蒙着一层不祥的水银，映出扭曲的符文倒影。他的掌心像干涸的河床一样裂开，微型如尼炮阵在血肉深处缓缓旋转，发出低沉的嗡鸣。炮口先对准墨菲，抖动着，仿佛在挣扎；然后缓缓转向自己的太阳穴，动作机械而决绝。施密特的嘴角扯出一个陌生的笑容，肌肉僵硬，像有人强行借用他的唇形："人类，你赢了。"声音不是他的，是某种古老而疲惫的回声。",
        "revision_note": "施密特形象改写：增加细节描写和心理暗示"
    }
}
```

**优势**：
- ✅ 精确定位要修改的段落
- ✅ 保留其他内容不变
- ✅ 自动创建备份
- ✅ 记录修改历史
- ✅ 支持回滚

---

## ⚠️ 重要提示

### diff 模式注意事项

1. **精确匹配**：`old_string` 必须与原文完全匹配（包括空格、换行）
2. **唯一定位**：如果 `old_string` 在文件中出现多次，工具会警告并拒绝替换
3. **包含上下文**：建议在 `old_string` 前后多包含几行，确保唯一匹配
4. **先读后写**：建议先用 `read_file` 读取文件，确认要替换的内容

### 最佳实践

✅ **推荐做法**：
```json
{
    "mode": "diff",
    "old_string": "完整的多行段落\n包含足够的上下文\n确保唯一匹配",
    "new_string": "改写后的完整段落\n保持格式一致",
    "revision_note": "清晰的修改说明"
}
```

❌ **不推荐做法**：
```json
{
    "mode": "diff",
    "old_string": "太短",  // ❌ 可能匹配到多处
    "new_string": "..."
}
```

---

## 📊 修改历史管理

### 查看修改历史

```json
{
    "tool": "view_revision_history",
    "params": {
        "type": "章节内容",
        "filename": "2025-10-02T05-51-00-896Z_Chapter 7 神陨滩头·诺曼底逆潮.md"
    }
}
```

**输出示例**：
```
📊 文件修改历史：章节内容/2025-10-02T05-51-00-896Z_Chapter 7 神陨滩头·诺曼底逆潮.md
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
共 3 次修改

第 3 次修改 - 2025/10/2 10:45:30
  模式：Diff 替换
  字数：8500 → 8700 (+200)
  说明：增加结尾段落的情感渲染
  备份：...backup-2025-10-02T10-45-30-123Z.md

第 2 次修改 - 2025/10/2 10:30:15
  模式：Diff 替换
  字数：8300 → 8500 (+200)
  说明：施密特形象改写
  备份：...backup-2025-10-02T10-30-15-456Z.md

第 1 次修改 - 2025/10/2 10:15:00
  模式：Diff 替换
  字数：8000 → 8300 (+300)
  说明：第一段描写改写
  备份：...backup-2025-10-02T10-15-00-789Z.md
```

### 回滚操作

如果需要回滚，可以手动恢复备份文件：
1. 找到备份文件（`.backup-<timestamp>.md`）
2. 复制备份文件的内容
3. 使用 `update_file` 的 `full` 模式覆盖当前文件

---

## 🎨 用户交互示例

### 示例 1：简单审稿

**用户**：
> "@Chapter 7 神陨滩头·诺曼底逆潮 帮我审稿，把开头第一段改得更有画面感"

**Agent 思考过程**：
```
Thought: 用户引用了 Chapter 7 文件，要求改写开头第一段。我需要：
1. 读取这个文件
2. 找到开头第一段
3. 改写使其更有画面感
4. 使用 diff 模式精确替换

Action: read_file
Action Input: {"type": "章节内容", "filename": "2025-10-02T05-51-00-896Z_Chapter 7 神陨滩头·诺曼底逆潮.md"}
```

**Agent 输出**：
```
✅ 已完成审稿改写！

📝 修改内容：
- 位置：开头第一段
- 修改方式：增加感官细节和动态描写
- 字数变化：+18 字

🔍 改写前：
英吉利海峡的浪头像被月亮磨亮的刀，一刀刀砍在登陆艇的钢板上。

🔍 改写后：
英吉利海峡的浪头像被月光淬炼的利刃，寒光凛凛，一刀接一刀重重砍在登陆艇的钢板上，溅起冰冷的水花。

💾 备份文件已自动保存，可随时回滚。
```

---

### 示例 2：多处改写

**用户**：
> "@Chapter 7 审稿：1) 开头第一段加强画面感 2) 施密特的描写更立体 3) 结尾增加情感渲染"

**Agent 会依次**：
1. 读取文件
2. 使用 `update_file` (diff 模式) 改写第一段
3. 使用 `update_file` (diff 模式) 改写施密特段落
4. 使用 `update_file` (diff 模式) 改写结尾
5. 总结所有修改

每次修改都会：
- ✅ 创建独立的备份
- ✅ 记录在修改历史中
- ✅ 显示 diff 预览

---

## 🚀 高级技巧

### 1. 批量审稿

让 Agent 自动审稿并改写：
```
"审稿 Chapter 7，找出所有描写不够生动的地方并改写"
```

### 2. 风格统一

```
"把 Chapter 7 的叙事风格改得跟 Chapter 6 一致"
```

### 3. 错误修正

```
"检查 Chapter 7 中的错别字和逻辑错误，逐一修正"
```

---

## 💡 总结

### 功能特点

✅ **精确替换**：diff 模式支持精确定位和替换  
✅ **自动备份**：每次修改自动创建备份文件  
✅ **历史记录**：完整的修改历史和 diff 预览  
✅ **安全可靠**：支持回滚，不会丢失原文  
✅ **灵活强大**：支持 diff 和 full 两种模式  

### 适用场景

📝 审稿改写  
🎨 风格调整  
🔧 错误修正  
✨ 细节增强  
📖 局部重写  

---

**开始使用**：
```
"@Chapter 7 帮我审稿并改写"
```

Agent 会自动：
1. 读取文件
2. 分析内容
3. 提出改写建议
4. 使用 `update_file` 工具精确更新
5. 显示 diff 对比和修改摘要

