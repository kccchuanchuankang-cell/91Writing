# 三栏布局 UI 设计文档

## 🎨 概述

参考 Cursor 的设计，实现了一个现代化的三栏布局界面，专为 AI 辅助写作场景优化。

## 📐 布局结构

```
┌─────────────────────────────────────────────────────────┐
│                   顶部工具栏                            │
│  🤖 ReAct Agent  [项目选择▼] [+]         [🗑️]          │
├─────────────┬───────────────────────┬───────────────────┤
│             │                       │                   │
│  文件导航   │      编辑器/Diff      │    AI 助手        │
│             │                       │                   │
│ 📁 文件     │ [标签1] [标签2*]      │ 💬 AI 助手        │
│  + 新建     │ [✓接受] [✗拒绝] [💾]  │                   │
│             │                       │                   │
│ 📁人物设定  │                       │ 对话历史...       │
│  ▶配角      │   文件内容            │                   │
│ 📁世界观    │   或                  │                   │
│ 📁章节内容  │   Diff 预览           │                   │
│  ▶第一章    │                       │                   │
│  ▶第二章    │                       │                   │
│             │                       │ [@ 引用] [📤上传]  │
│             │                       │ [输入框...] [发送] │
└─────────────┴───────────────────────┴───────────────────┘
```

## 🎯 核心功能

### 1. 左栏：文件导航
- **功能**：项目文件树，按类型分组
- **交互**：
  - 点击文件夹展开/折叠
  - 点击文件在中间区域打开
  - 支持新建文件

### 2. 中栏：编辑器/Diff 预览
- **多标签编辑器**：支持同时打开多个文件
- **三种视图模式**：
  1. **欢迎页**：系统介绍和快速入门
  2. **文件编辑器**：查看和编辑文件内容
  3. **Diff 视图**：预览 AI 建议的修改

- **Diff 功能**：
  - 行级对比显示
  - 统计信息（行数变化）
  - 接受/拒绝修改按钮
  - 自动备份

### 3. 右栏：AI 助手
- **对话界面**：与 AI 交互
- **文件引用**：@ 提及文件，上传本地文件
- **实时反馈**：显示 AI 思考过程
- **流式输出**：逐字显示生成内容

## 🔄 AI 操作文件的完整流程

### 场景：用户让 AI 审稿改写

1. **用户输入**（右栏）：
   ```
   "@Chapter 7 帮我审稿，把第一段改得更生动"
   ```

2. **AI 处理**：
   - 调用 `read_file` 读取文件
   - 分析内容并改写
   - 调用 `update_file` 工具（不直接保存）

3. **前端接收 diff 数据**：
   ```json
   {
     "type": "diff",
     "data": {
       "type": "章节内容",
       "filename": "xxx.md",
       "oldContent": "原始内容...",
       "newContent": "修改后内容...",
       "revisionNote": "第一段改写：增加感官细节"
     }
   }
   ```

4. **自动在中间区域显示 diff**：
   - 左栏自动选中对应文件
   - 中栏切换到 Diff 视图
   - 高亮显示修改的行

5. **用户决策**：
   - **点击「✓ 接受修改」**：
     - 调用后端 API 保存文件
     - 自动创建备份
     - 记录修改历史
     - 切换到编辑器视图显示新内容
     - 聊天区显示"✅ 修改已接受并保存"
   
   - **点击「✗ 拒绝修改」**：
     - 放弃修改
     - 保持原内容
     - 切换回编辑器视图
     - 聊天区显示"❌ 修改已拒绝"

## 📡 前后端通信协议

### SSE 流式响应增强

```javascript
// 原有的文本块
data: {"type": "chunk", "data": "AI 生成的文本..."}

// 新增：文件操作事件
data: {"type": "file_operation", "data": {
  "operation": "read",
  "type": "章节内容",
  "filename": "xxx.md",
  "title": "Chapter 7"
}}

// 新增：Diff 事件
data: {"type": "diff", "data": {
  "type": "章节内容",
  "filename": "xxx.md",
  "oldContent": "...",
  "newContent": "...",
  "revisionNote": "改写说明"
}}

// 完成信号
data: {"type": "done"}
```

### update_file 工具返回格式

需要修改 `update_file` 工具，让它返回结构化数据：

```json
{
  "success": true,
  "action": "update_file",
  "data": {
    "type": "章节内容",
    "filename": "xxx.md",
    "oldContent": "...",
    "newContent": "...",
    "mode": "diff",
    "revisionNote": "...",
    "stats": {
      "oldLines": 100,
      "newLines": 105,
      "oldChars": 3000,
      "newChars": 3150
    }
  },
  "message": "✅ 文件更新成功"
}
```

## 🎨 Diff 显示样式

使用三种颜色标记：
- 🟢 **绿色背景**：新增的行 (`+ 内容`)
- 🔴 **红色背景**：删除的行 (`- 内容`)
- ⚪ **灰色文本**：未修改的上下文 (`  内容`)

## 🔧 技术栈

### 前端
- **Marked.js**：Markdown 渲染
- **Diff2Html**（可选）：美化 diff 显示
- **Highlight.js**：代码语法高亮

### 后端
- **Server-Sent Events (SSE)**：流式传输
- **文件系统操作**：Node.js `fs` 模块
- **ReAct Agent**：LangChain 集成

## 📱 响应式设计

### 桌面端 (> 1024px)
- 左栏：260px
- 中栏：flex-grow (自适应)
- 右栏：380px

### 平板端 (768px - 1024px)
- 左栏：200px
- 右栏：320px

### 移动端 (< 768px)
- 垂直布局
- 左栏 + 右栏：各占 30vh（可滚动）
- 中栏：占剩余空间

## 🚀 实施路线图

### Phase 1: 基础布局 ✅
- [x] HTML 结构
- [x] CSS 样式
- [x] 基础 JavaScript

### Phase 2: 核心功能 🔄
- [x] 文件树渲染
- [x] 标签页管理
- [x] 编辑器视图切换
- [x] 简单 Diff 显示
- [ ] 增强 Agent 工具返回格式

### Phase 3: AI 集成 📝
- [ ] 修改 `update_file` 工具
- [ ] 修改 `server.js` 流式响应
- [ ] 实现 diff 事件推送
- [ ] 实现接受/拒绝修改 API

### Phase 4: 优化提升 🎯
- [ ] 集成 Diff2Html
- [ ] 添加语法高亮
- [ ] 性能优化
- [ ] 移动端适配
- [ ] 键盘快捷键

## 📖 使用指南

### 启动新 UI

1. 访问 `http://localhost:3000/index-new.html`
2. 选择或创建项目
3. 在右侧对话框与 AI 交流
4. AI 修改文件时，会在中间区域显示 diff
5. 选择接受或拒绝修改

### 快捷键（计划中）

- `Ctrl/Cmd + S`：保存当前文件
- `Ctrl/Cmd + W`：关闭当前标签
- `Ctrl/Cmd + Tab`：切换标签
- `Ctrl/Cmd + B`：切换文件树显示/隐藏

## 🎉 优势

1. **直观的可视化**：Diff 显示一目了然
2. **用户掌控**：明确的接受/拒绝选择
3. **安全可靠**：自动备份，可追溯历史
4. **流畅体验**：流式传输，实时反馈
5. **专业工具**：类 IDE 的编辑体验

## 🔮 未来展望

- **并排 Diff**：左右对比视图
- **部分接受**：选择性接受某些修改
- **冲突解决**：处理并发编辑冲突
- **版本管理**：Git 集成
- **协作编辑**：多人实时协作

---

**开始体验新 UI**：`http://localhost:3000/index-new.html`

