import fs from 'fs';
import path from 'path';

/**
 * å°è¯´é¡¹ç›®ç»“æž„ç®¡ç†å™¨
 * è´Ÿè´£åˆ›å»ºå’Œç®¡ç†å°è¯´é¡¹ç›®çš„ç›®å½•ç»“æž„
 */
export class ProjectManager {
    constructor(projectName, baseDir = './novels') {
        this.projectName = projectName;
        this.baseDir = baseDir;
        this.projectDir = path.join(baseDir, projectName);
        
        // å®šä¹‰é¡¹ç›®ç»“æž„ï¼ˆå…¨éƒ¨ä½¿ç”¨ä¸­æ–‡ç›®å½•åï¼‰
        this.structure = {
            'çµæ„Ÿè®°å½•': 'çµæ„Ÿè®°å½•',
            'äººç‰©è®¾å®š': 'äººç‰©è®¾å®š', 
            'ä¸–ç•Œè§‚è®¾å®š': 'ä¸–ç•Œè§‚è®¾å®š',
            'ç« èŠ‚å†…å®¹': 'ç« èŠ‚å†…å®¹',
            'å¤§çº²': 'å¤§çº²',
            'è®¾å®šèµ„æ–™': 'è®¾å®šèµ„æ–™',
            'åˆ›ä½œç¬”è®°': 'åˆ›ä½œç¬”è®°'
        };
    }

    /**
     * åˆå§‹åŒ–é¡¹ç›®ç›®å½•ç»“æž„
     */
    async initProject() {
        try {
            // åˆ›å»ºåŸºç¡€ç›®å½•
            if (!fs.existsSync(this.baseDir)) {
                fs.mkdirSync(this.baseDir, { recursive: true });
            }
            
            if (!fs.existsSync(this.projectDir)) {
                fs.mkdirSync(this.projectDir, { recursive: true });
            }

            // åˆ›å»ºå­ç›®å½•
            for (const [chineseName, englishName] of Object.entries(this.structure)) {
                const dirPath = path.join(this.projectDir, englishName);
                if (!fs.existsSync(dirPath)) {
                    fs.mkdirSync(dirPath, { recursive: true });
                }
            }

            // åˆ›å»ºé¡¹ç›®é…ç½®æ–‡ä»¶
            const configPath = path.join(this.projectDir, 'project-config.json');
            if (!fs.existsSync(configPath)) {
                const config = {
                    projectName: this.projectName,
                    createdAt: new Date().toISOString(),
                    lastModified: new Date().toISOString(),
                    structure: this.structure,
                    metadata: {
                        genre: '',
                        tags: [],
                        description: '',
                        status: 'planning'
                    }
                };
                fs.writeFileSync(configPath, JSON.stringify(config, null, 2), 'utf8');
            }

            // åˆ›å»ºç´¢å¼•æ–‡ä»¶
            await this.createIndexFiles();
            
            // åˆ›å»ºæç¤ºè¯çŸ¥è¯†åº“
            await this.createPromptKnowledgeBase();

            console.log(`âœ… é¡¹ç›® "${this.projectName}" åˆå§‹åŒ–å®Œæˆ`);
            console.log(`ðŸ“ é¡¹ç›®è·¯å¾„: ${this.projectDir}`);
            
            return this.projectDir;
        } catch (error) {
            console.error('âŒ é¡¹ç›®åˆå§‹åŒ–å¤±è´¥:', error);
            throw error;
        }
    }

    /**
     * åˆ›å»ºå„ç±»åž‹çš„ç´¢å¼•æ–‡ä»¶
     */
    async createIndexFiles() {
        const indexFiles = {
            'çµæ„Ÿè®°å½•/index.md': '# çµæ„Ÿè®°å½•ç´¢å¼•\n\n> è®°å½•æ‰€æœ‰åˆ›ä½œçµæ„Ÿå’Œæƒ³æ³•\n\n',
            'äººç‰©è®¾å®š/index.md': '# äººç‰©è®¾å®šç´¢å¼•\n\n> è®°å½•æ‰€æœ‰è§’è‰²çš„è¯¦ç»†è®¾å®š\n\n## ä¸»è¦è§’è‰²\n\n## æ¬¡è¦è§’è‰²\n\n',
            'ä¸–ç•Œè§‚è®¾å®š/index.md': '# ä¸–ç•Œè§‚è®¾å®šç´¢å¼•\n\n> è®°å½•ä¸–ç•Œè§‚ã€èƒŒæ™¯è®¾å®šç­‰\n\n## ä¸–ç•ŒèƒŒæ™¯\n\n## è®¾å®šè§„åˆ™\n\n',
            'ç« èŠ‚å†…å®¹/index.md': '# ç« èŠ‚å†…å®¹ç´¢å¼•\n\n> è®°å½•æ‰€æœ‰ç« èŠ‚å†…å®¹\n\n',
            'å¤§çº²/index.md': '# å¤§çº²ç´¢å¼•\n\n> è®°å½•æ•…äº‹å¤§çº²å’Œæƒ…èŠ‚å®‰æŽ’\n\n',
            'è®¾å®šèµ„æ–™/index.md': '# è®¾å®šèµ„æ–™ç´¢å¼•\n\n> è®°å½•å‚è€ƒèµ„æ–™å’Œè®¾å®šç»†èŠ‚\n\n',
            'åˆ›ä½œç¬”è®°/index.md': '# åˆ›ä½œç¬”è®°ç´¢å¼•\n\n> è®°å½•åˆ›ä½œè¿‡ç¨‹ä¸­çš„æƒ³æ³•å’Œç¬”è®°\n\n'
        };

        for (const [filePath, content] of Object.entries(indexFiles)) {
            const fullPath = path.join(this.projectDir, filePath);
            if (!fs.existsSync(fullPath)) {
                fs.writeFileSync(fullPath, content, 'utf8');
            }
        }
    }

    /**
     * åˆ›å»ºæç¤ºè¯çŸ¥è¯†åº“æ–‡æ¡£
     * AIä¼šåœ¨éœ€è¦æ—¶è‡ªåŠ¨è¯»å–è¿™ä¸ªæ–‡æ¡£
     */
    async createPromptKnowledgeBase() {
        const promptPath = path.join(this.projectDir, 'åˆ›ä½œæç¤ºè¯çŸ¥è¯†åº“.md');
        
        if (fs.existsSync(promptPath)) {
            return; // å¦‚æžœå·²å­˜åœ¨ï¼Œä¸è¦†ç›–
        }

        const content = `# åˆ›ä½œæç¤ºè¯çŸ¥è¯†åº“

> è¿™æ˜¯ä¸€ä¸ªæç¤ºè¯çŸ¥è¯†åº“ï¼ŒAIåœ¨åˆ›ä½œæ—¶ä¼šæ ¹æ®éœ€è¦è‡ªåŠ¨è¯»å–ç›¸å…³éƒ¨åˆ†ã€‚
> ä½ å¯ä»¥åœ¨è¿™é‡Œå®šåˆ¶ä»»ä½•åˆ›ä½œé£Žæ ¼ã€æ ¼å¼è¦æ±‚ã€å‚è€ƒç¤ºä¾‹ç­‰ã€‚
> AIä¼šæ ¹æ®ä½ çš„åˆ›ä½œä»»åŠ¡ï¼Œæ™ºèƒ½æœç´¢å’Œåº”ç”¨è¿™äº›æç¤ºè¯ã€‚

---

## ðŸ“ ç« èŠ‚æ­£æ–‡åˆ›ä½œæç¤ºè¯

### é£Žæ ¼å‚è€ƒï¼šé®å¤©é£Žæ ¼
- ä½¿ç”¨å¤§æ°”ç£…ç¤´çš„ç¬”è§¦æå†™åœºæ™¯å’Œæˆ˜æ–—
- æ³¨é‡æ„å¢ƒè¥é€ ï¼Œé€‚å½“ä½¿ç”¨è¯—æ„åŒ–çš„è¯­è¨€
- æˆ˜æ–—åœºé¢è¦æœ‰å±‚æ¬¡æ„Ÿï¼Œä½“çŽ°åŠ›é‡çš„å±‚çº§å·®å¼‚
- äººç‰©å¯¹è¯è¦æœ‰æ·±æ„ï¼Œé¿å…è¿‡äºŽç›´ç™½
- é€‚å½“ç•™ç™½ï¼Œç»™è¯»è€…æƒ³è±¡ç©ºé—´

### é£Žæ ¼å‚è€ƒï¼šå…¶ä»–é£Žæ ¼
ï¼ˆä½ å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å…¶ä»–é£Žæ ¼ï¼šå¦‚è½»æ¾æ—¥å¸¸ã€æ‚¬ç–‘æŽ¨ç†ã€çƒ­è¡€æˆ˜æ–—ç­‰ï¼‰

### ç« èŠ‚ç»“æž„å»ºè®®
- å¼€å¤´ï¼šå¼•å…¥å†²çªæˆ–æ‚¬å¿µï¼ŒæŠ“ä½è¯»è€…
- ä¸­é—´ï¼šæƒ…èŠ‚å‘å±•å’Œå†²çªå‡çº§
- ç»“å°¾ï¼šç•™ä¸‹é’©å­æˆ–è½¬æŠ˜ï¼Œå¼•å¯¼ä¸‹ä¸€ç« 

### æå†™é‡ç‚¹
- äººç‰©å¿ƒç†æ´»åŠ¨è¦ç»†è…»
- åœºæ™¯æ°›å›´è¦æ¸²æŸ“åˆ°ä½
- åŠ¨ä½œç»†èŠ‚è¦ç”ŸåŠ¨å½¢è±¡
- å¯¹è¯è¦ç¬¦åˆäººç‰©æ€§æ ¼

---

## ðŸ‘¤ äººç‰©è®¾å®šåˆ›ä½œæç¤ºè¯

### æ ‡å‡†æ ¼å¼æ¨¡æ¿
ä¸€ä¸ªå®Œæ•´çš„äººç‰©è®¾å®šåº”åŒ…å«ï¼š

**åŸºæœ¬ä¿¡æ¯**
- å§“åï¼šï¼ˆåŒ…æ‹¬åˆ«åã€å¤–å·ï¼‰
- å¹´é¾„ï¼š
- æ€§åˆ«ï¼š
- èº«ä»½/èŒä¸šï¼š
- å®žåŠ›ç­‰çº§ï¼šï¼ˆå¦‚é€‚ç”¨ï¼‰

**å¤–è²Œç‰¹å¾**
- èº«é«˜ä½“åž‹
- é¢å®¹ç‰¹å¾
- ç©¿ç€æ‰“æ‰®
- æ ‡å¿—æ€§ç‰¹å¾

**æ€§æ ¼ç‰¹ç‚¹**
- æ ¸å¿ƒæ€§æ ¼ï¼ˆ3-5ä¸ªå…³é”®è¯ï¼‰
- è¡Œä¸ºä¹ æƒ¯
- è¯´è¯æ–¹å¼/å£å¤´ç¦…
- æ€§æ ¼å½¢æˆåŽŸå› 

**èƒŒæ™¯æ•…äº‹**
- å‡ºèº«èƒŒæ™¯
- æˆé•¿ç»åŽ†
- é‡è¦è½¬æŠ˜ç‚¹
- äººé™…å…³ç³»ç½‘

**èƒ½åŠ›ä¸Žç‰¹é•¿**
- ç‰¹æ®Šèƒ½åŠ›/æŠ€èƒ½
- æˆ˜æ–—é£Žæ ¼ï¼ˆå¦‚é€‚ç”¨ï¼‰
- ä¼˜åŠ¿ä¸Žå¼±ç‚¹

**è§’è‰²å®šä½**
- åœ¨æ•…äº‹ä¸­çš„ä½œç”¨
- ä¸Žä¸»è§’çš„å…³ç³»
- æˆé•¿è·¯çº¿

### åˆ›ä½œåŽŸåˆ™
- æ€§æ ¼è¦ç«‹ä½“ï¼Œé¿å…è„¸è°±åŒ–
- èƒŒæ™¯è¦åˆç†ï¼Œç¬¦åˆä¸–ç•Œè§‚
- è¡Œä¸ºè¦ä¸€è‡´ï¼Œç¬¦åˆæ€§æ ¼
- æœ‰æˆé•¿ç©ºé—´å’Œå†²çªç‚¹

---

## ðŸŒ ä¸–ç•Œè§‚è®¾å®šåˆ›ä½œæç¤ºè¯

### è®¾å®šè¦ç´ 
- **æ—¶ä»£èƒŒæ™¯**ï¼šçŽ°ä»£/å¤ä»£/æœªæ¥/æž¶ç©º
- **åœ°ç†çŽ¯å¢ƒ**ï¼šä¸–ç•Œæ ¼å±€ã€é‡è¦åœ°ç‚¹
- **ç¤¾ä¼šç»“æž„**ï¼šé˜¶å±‚ã€ç»„ç»‡ã€åŠ¿åŠ›
- **æ–‡åŒ–ç‰¹è‰²**ï¼šé£Žä¿—ã€ä¿¡ä»°ã€ä»·å€¼è§‚

### åŠ›é‡ä½“ç³»
- åŠ›é‡æ¥æºå’ŒåŽŸç†
- ç­‰çº§åˆ’åˆ†æ ‡å‡†
- ä¿®ç‚¼/æå‡æ–¹å¼
- é™åˆ¶å’Œä»£ä»·

### åˆ›ä½œåŽŸåˆ™
- **è‡ªæ´½æ€§**ï¼šè®¾å®šå†…éƒ¨é€»è¾‘è¦è‡ªæ´½
- **ç‹¬ç‰¹æ€§**ï¼šæœ‰ç‹¬ç‰¹çš„ä¸–ç•Œè§‚ç‰¹è‰²
- **å¯æ‰©å±•æ€§**ï¼šä¸ºåŽç»­æƒ…èŠ‚ç•™å‡ºç©ºé—´
- **æœåŠ¡æ€§**ï¼šè®¾å®šè¦æœåŠ¡äºŽæ•…äº‹

---

## ðŸ“‹ å¤§çº²åˆ›ä½œæç¤ºè¯

### å¤§çº²å±‚æ¬¡
- **æ€»çº²**ï¼šæ•´ä½“æ•…äº‹èµ°å‘
- **å·/éƒ¨åˆ†å¤§çº²**ï¼šå¤§çš„æƒ…èŠ‚é˜¶æ®µ
- **ç« èŠ‚å¤§çº²**ï¼šå…·ä½“ç« èŠ‚å®‰æŽ’

### ç« èŠ‚å¤§çº²è¦ç´ 
- ç« èŠ‚æ ‡é¢˜
- æ ¸å¿ƒäº‹ä»¶
- å†²çªä¸Žè½¬æŠ˜
- äººç‰©å˜åŒ–
- ä¼ç¬”ä¸Žå‘¼åº”
- å¯¹æ€»ä½“æƒ…èŠ‚çš„æŽ¨è¿›ä½œç”¨

---

## ðŸŽ¯ äº‹ä»¶çº¿/æƒ…èŠ‚çº¿æç¤ºè¯

### äº‹ä»¶çº¿ç±»åž‹
- **ä¸»çº¿**ï¼šæ ¸å¿ƒæƒ…èŠ‚
- **æ”¯çº¿**ï¼šè¾…åŠ©æƒ…èŠ‚
- **æš—çº¿**ï¼šéšè—ä¼ç¬”

### å¤šçº¿ç´¢ç®¡ç†
- ä¸»çº¿ä¸Žæ”¯çº¿äº¤ç»‡æŽ¨è¿›
- é¿å…æŸæ¡çº¿æ–­çº¿å¤ªä¹…
- æ³¨æ„å„çº¿ç´¢çš„å…³è”å’Œå‘¼åº”
- ä¸»æ¬¡åˆ†æ˜Ž

---

## ðŸ’¡ åˆ›ä½œé€šç”¨åŽŸåˆ™

### è´¨é‡è¦æ±‚
- ä¿æŒå†…å®¹è´¨é‡å’Œè¿žè´¯æ€§
- éµå¾ªå·²æœ‰è®¾å®šï¼Œä¸éšæ„æ›´æ”¹
- æ³¨æ„æƒ…èŠ‚é€»è¾‘æ€§å’Œåˆç†æ€§
- ä¿æŒè§’è‰²æ€§æ ¼ä¸€è‡´æ€§

### è¯­è¨€é£Žæ ¼
- ä½¿ç”¨ç”ŸåŠ¨å½¢è±¡çš„æå†™
- æ³¨æ„èŠ‚å¥å’Œæ°›å›´è¥é€ 
- é¿å…é‡å¤å’Œå•°å—¦
- é€‚å½“ä½¿ç”¨ä¿®è¾žæ‰‹æ³•

### æ³¨æ„äº‹é¡¹
- æ£€æŸ¥æ˜¯å¦ä¸Žå·²æœ‰å†…å®¹å†²çª
- ç¡®ä¿æ—¶é—´çº¿å’Œå› æžœå…³ç³»æ­£ç¡®
- ä¼ç¬”è¦è®°å½•æ¸…æ¥š
- é‡è¦è®¾å®šè¦ä¿æŒä¸€è‡´

---

## ðŸ“š å‚è€ƒç¤ºä¾‹ï¼ˆå¯é€‰ï¼‰

### å¼€å¤´ç¤ºä¾‹
ï¼ˆä½ å¯ä»¥åœ¨è¿™é‡Œç²˜è´´ä½ å–œæ¬¢çš„å°è¯´å¼€å¤´ä½œä¸ºå‚è€ƒï¼‰

### äººç‰©æå†™ç¤ºä¾‹
ï¼ˆç²˜è´´ä¼˜ç§€çš„äººç‰©æå†™ç‰‡æ®µï¼‰

### æˆ˜æ–—åœºé¢ç¤ºä¾‹
ï¼ˆç²˜è´´ç²¾å½©çš„æˆ˜æ–—æå†™ï¼‰

---

## è‡ªå®šä¹‰åŒºåŸŸ

ï¼ˆåœ¨è¿™é‡Œæ·»åŠ ä»»ä½•ä½ éœ€è¦çš„æç¤ºè¯ã€å‚è€ƒèµ„æ–™ã€åˆ›ä½œè¦æ±‚ç­‰ï¼‰
ï¼ˆAIä¼šæ™ºèƒ½æœç´¢å’Œåº”ç”¨è¿™é‡Œçš„å†…å®¹ï¼‰

`;

        fs.writeFileSync(promptPath, content, 'utf8');
        console.log('âœ… åˆ›ä½œæç¤ºè¯çŸ¥è¯†åº“å·²åˆ›å»º');
    }

    /**
     * èŽ·å–é¡¹ç›®ä¿¡æ¯
     */
    getProjectInfo() {
        const configPath = path.join(this.projectDir, 'project-config.json');
        if (fs.existsSync(configPath)) {
            return JSON.parse(fs.readFileSync(configPath, 'utf8'));
        }
        return null;
    }

    /**
     * æ›´æ–°é¡¹ç›®é…ç½®
     */
    updateProjectConfig(updates) {
        const configPath = path.join(this.projectDir, 'project-config.json');
        if (fs.existsSync(configPath)) {
            const config = JSON.parse(fs.readFileSync(configPath, 'utf8'));
            Object.assign(config, updates);
            config.lastModified = new Date().toISOString();
            fs.writeFileSync(configPath, JSON.stringify(config, null, 2), 'utf8');
        }
    }

    /**
     * èŽ·å–æŒ‡å®šç±»åž‹çš„ç›®å½•è·¯å¾„
     */
    getTypeDir(type) {
        const englishName = this.structure[type] || type;
        return path.join(this.projectDir, englishName);
    }

    /**
     * åˆ—å‡ºé¡¹ç›®ä¸­çš„æ‰€æœ‰æ–‡ä»¶
     */
    listProjectFiles() {
        const files = {};
        for (const [chineseName, englishName] of Object.entries(this.structure)) {
            const dirPath = path.join(this.projectDir, englishName);
            if (fs.existsSync(dirPath)) {
                files[chineseName] = fs.readdirSync(dirPath)
                    .filter(file => file.endsWith('.md') || file.endsWith('.txt'))
                    .map(file => path.join(dirPath, file));
            }
        }
        return files;
    }
}